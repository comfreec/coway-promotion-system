name: ìë™ SMS ë°œì†¡ ì‹œìŠ¤í…œ

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œì— ì‹¤í–‰ (KST)
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  
  # ìƒˆë¡œìš´ í”„ë¡œëª¨ì…˜ì´ ì¶”ê°€ë  ë•Œ ìë™ ì‹¤í–‰
  repository_dispatch:
    types: [new-promotion-alert]

jobs:
  send-sms-notifications:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm install
      
    - name: ğŸ“… í˜„ì¬ ë‚ ì§œ ì„¤ì •
      id: date
      run: |
        echo "day=$(date +%A | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
        echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
        
    - name: ğŸ” í”„ë¡œëª¨ì…˜ ë³€ê²½ì‚¬í•­ í™•ì¸
      id: check-changes
      run: |
        # ìµœê·¼ 24ì‹œê°„ ë‚´ í”„ë¡œëª¨ì…˜ íŒŒì¼ ë³€ê²½ í™•ì¸
        CHANGES=$(git log --since="24 hours ago" --oneline --name-only | grep -E "(promotions.json|index.html)" | wc -l)
        echo "changes=$CHANGES" >> $GITHUB_OUTPUT
        echo "ğŸ“Š ìµœê·¼ 24ì‹œê°„ ë‚´ í”„ë¡œëª¨ì…˜ ê´€ë ¨ ë³€ê²½: $CHANGESê±´"
        
    - name: ğŸ“± ì‹ ê·œ í”„ë¡œëª¨ì…˜ ê¸´ê¸‰ ì•Œë¦¼
      if: steps.check-changes.outputs.changes > 0
      env:
        COOLSMS_API_KEY: ${{ secrets.COOLSMS_API_KEY }}
        COOLSMS_API_SECRET: ${{ secrets.COOLSMS_API_SECRET }}
        SMS_SENDER: ${{ secrets.SMS_SENDER }}
      run: |
        echo "ğŸš¨ ì‹ ê·œ í”„ë¡œëª¨ì…˜ ë°œê²¬! ê¸´ê¸‰ ì•Œë¦¼ ë°œì†¡"
        node sms-sender.js --emergency
        
    - name: ğŸ“¢ ì •ê¸° í”„ë¡œëª¨ì…˜ ì•Œë¦¼ (ì›”ìš”ì¼)
      if: github.event.schedule && steps.date.outputs.day == 'monday'
      env:
        COOLSMS_API_KEY: ${{ secrets.COOLSMS_API_KEY }}
        COOLSMS_API_SECRET: ${{ secrets.COOLSMS_API_SECRET }}
        SMS_SENDER: ${{ secrets.SMS_SENDER }}
      run: |
        echo "ğŸ“… ì£¼ê°„ ì •ê¸° í”„ë¡œëª¨ì…˜ ì•Œë¦¼ ë°œì†¡"
        node sms-sender.js --weekly
        
    - name: ğŸ¯ ë§ì¶¤ í”„ë¡œëª¨ì…˜ ì•Œë¦¼ (ìˆ˜ìš”ì¼)
      if: github.event.schedule && steps.date.outputs.day == 'wednesday'
      env:
        COOLSMS_API_KEY: ${{ secrets.COOLSMS_API_KEY }}
        COOLSMS_API_SECRET: ${{ secrets.COOLSMS_API_SECRET }}
        SMS_SENDER: ${{ secrets.SMS_SENDER }}
      run: |
        echo "ğŸ¯ ê³ ê° ë§ì¶¤ í”„ë¡œëª¨ì…˜ ì•Œë¦¼ ë°œì†¡"
        node sms-sender.js --personalized
        
    - name: ğŸ“Š ë°œì†¡ ê²°ê³¼ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sms-report-${{ github.run_number }}
        path: sms-report.json
        retention-days: 30
        
    - name: ğŸ’¬ Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      if: failure()
      run: |
        echo "âŒ SMS ë°œì†¡ ì‹¤íŒ¨ ì•Œë¦¼ì„ Slackìœ¼ë¡œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤"
        # Slack webhook ì„¤ì • ì‹œ ì‚¬ìš©
        
    - name: ğŸ“ˆ ë°œì†¡ í†µê³„ ì»¤ë°‹
      if: steps.check-changes.outputs.changes > 0
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ë°œì†¡ í†µê³„ë¥¼ READMEì— ì¶”ê°€
        echo "## ğŸ“± ìµœê·¼ SMS ë°œì†¡ í˜„í™©" >> SMS_STATS.md
        echo "- ë°œì†¡ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')" >> SMS_STATS.md
        echo "- ë³€ê²½ì‚¬í•­: ${{ steps.check-changes.outputs.changes }}ê±´" >> SMS_STATS.md
        echo "" >> SMS_STATS.md
        
        git add SMS_STATS.md sms-report.json
        git commit -m "ğŸ“± SMS ë°œì†¡ í†µê³„ ì—…ë°ì´íŠ¸ $(date '+%Y-%m-%d')" || exit 0
        git push